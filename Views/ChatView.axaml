<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:TagForge.ViewModels"
             xmlns:models="using:TagForge.Models"
             xmlns:conv="using:TagForge.Converters"
             xmlns:ext="using:TagForge.Extensions"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="450"
             x:DataType="vm:ChatViewModel"
             x:Name="Root"
             x:Class="TagForge.Views.ChatView">

  <UserControl.Resources>
      <conv:RoleToAlignmentConverter x:Key="RoleAligned"/>
      <conv:RoleToBackgroundConverter x:Key="RoleBg"/>
      <conv:RoleToCornerRadiusConverter x:Key="RoleCorner"/>
      <conv:RoleToAvatarIconConverter x:Key="AvatarIcon"/>
      <conv:RoleToAvatarBackgroundConverter x:Key="AvatarBg"/>
      <conv:RoleToAvatarForegroundConverter x:Key="AvatarFg"/>
      <conv:BooleanToBrushConverter x:Key="BoolToBrush"/>
      <conv:RoleToAvatarColumnConverter x:Key="AvatarCol"/>
      <conv:RoleToMessageColumnConverter x:Key="MessageCol"/>
      <conv:RoleToAvatarMarginConverter x:Key="AvatarMargin"/>
  </UserControl.Resources>
  
  <Grid>
      
      <!-- Chat Area -->
      <Grid RowDefinitions="Auto, *, Auto">
          
          <!-- Solid Header -->
          <Border Grid.Row="0" 
                  Background="#252525" 
                  Padding="20"
                  BorderBrush="#333333" 
                  BorderThickness="0,0,0,1">
              <Grid ColumnDefinitions="Auto, *, Auto">
                  
                  <!-- Title Section -->
                  <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                      <PathIcon Data="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M20,16H6L4,18V4H20" 
                                Width="18" Height="18" 
                                Foreground="{DynamicResource AccentBrush}"/>
                      <TextBlock Text="{ext:Localize Chat.Title}" 
                                 FontWeight="Bold" 
                                 FontSize="16" 
                                 VerticalAlignment="Center"
                                 Foreground="#E0E0E0"/>
                  </StackPanel>

                  <!-- New Session Button -->
                  <Button Grid.Column="2" 
                          Command="{Binding CreateNewSessionCommand}" 
                          Height="40"
                          Width="40"
                          Background="#333333"
                          Foreground="#6B8AFF"
                          FontSize="20"
                          CornerRadius="6"
                          BorderThickness="0"
                          ToolTip.Tip="{ext:Localize History.NewSession}"
                          HorizontalContentAlignment="Center"
                          VerticalContentAlignment="Center">
                      <TextBlock Text="+" Margin="0,-2,0,0"/>
                  </Button>
              </Grid>
          </Border>

          <!-- Chat History -->
          <ScrollViewer x:Name="ChatScroller" Grid.Row="1" Margin="20,15,20,10">
              <ItemsControl ItemsSource="{Binding Messages}" Margin="0,0,15,0">
                  <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                          <StackPanel Spacing="15"/>
                      </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                      <DataTemplate DataType="models:ChatMessage">
                          <Grid ColumnDefinitions="Auto, *" HorizontalAlignment="{Binding Role, Converter={StaticResource RoleAligned}}">
                              <!-- Avatar -->
                              <Border Grid.Column="{Binding Role, Converter={StaticResource AvatarCol}}" 
                                      Width="32" Height="32" 
                                      CornerRadius="16" 
                                      Background="{Binding Role, Converter={StaticResource AvatarBg}}"
                                      Margin="{Binding Role, Converter={StaticResource AvatarMargin}}" 
                                      VerticalAlignment="Top">
                                  <PathIcon Data="{Binding Role, Converter={StaticResource AvatarIcon}}"
                                            Width="18" Height="18"
                                            Foreground="{Binding Role, Converter={StaticResource AvatarFg}}"/>
                              </Border>
                              
                              <!-- Message Content -->
                              <Border Grid.Column="{Binding Role, Converter={StaticResource MessageCol}}"
                                      CornerRadius="{Binding Role, Converter={StaticResource RoleCorner}}" 
                                      Background="{Binding Role, Converter={StaticResource RoleBg}}" 
                                      Padding="15" MaxWidth="600"
                                      BoxShadow="0 2 5 0 #20000000">
                                  <StackPanel Spacing="5">
                                      
                                      <Panel>
                                          <!-- Loading Model Indicator -->
                                          <StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding IsLoadingModel}" Margin="0,5">
                                              <ProgressBar IsIndeterminate="True" Width="60" Height="2" VerticalAlignment="Center" Foreground="{DynamicResource AccentBrush}"/>
                                              <TextBlock Text="{ext:Localize Status.Loading}" Foreground="#888" FontSize="12"/>
                                          </StackPanel>

                                          <!-- Thinking Indicator -->
                                          <StackPanel Orientation="Horizontal" Spacing="10" IsVisible="{Binding IsThinking}" Margin="0,5">
                                              <ProgressBar IsIndeterminate="True" Width="40" Height="2" VerticalAlignment="Center" Foreground="{DynamicResource AccentBrush}"/>
                                              <TextBlock Text="{ext:Localize Chat.Generating}" Foreground="#888" FontSize="12" FontStyle="Italic"/>
                                          </StackPanel>

                                          <!-- Content -->
                                          <SelectableTextBlock Text="{Binding Content}" TextWrapping="Wrap" LineHeight="22" Foreground="#E0E0E0"
                                                               IsVisible="{Binding !IsThinking}"/>
                                      </Panel>
                                      
                                      <!-- Footer / Timestamp -->
                                      <Grid ColumnDefinitions="*, Auto, Auto" Margin="0,5,0,0">
                                          <TextBlock Text="{Binding Timestamp}" Foreground="#666" FontSize="10" VerticalAlignment="Center" Grid.Column="1" Margin="0,0,10,0"/>
                                          
                                          <Button Grid.Column="2" Classes="ghost" Padding="5" 
                                                  x:CompileBindings="False"
                                                  Command="{Binding #Root.DataContext.CopyMessageCommand}" 
                                                  CommandParameter="{Binding Content}"
                                                  ToolTip.Tip="{ext:Localize Common.Copy}">
                                              <PathIcon Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" 
                                                        Width="12" Height="12" Foreground="#666"/>
                                          </Button>
                                      </Grid>
                                  </StackPanel>
                              </Border>
                          </Grid>
                      </DataTemplate>
                  </ItemsControl.ItemTemplate>
              </ItemsControl>
          </ScrollViewer>

          <!-- Bottom Floating Input -->
          <Grid Grid.Row="2" Margin="30,10,30,20">
              <Border Background="#303030" CornerRadius="25" Padding="5" BoxShadow="0 4 15 0 #30000000" BorderBrush="#404040" BorderThickness="1">
                  <Grid ColumnDefinitions="*, Auto">
                      <TextBox Text="{Binding Prompt}" 
                               Watermark="{ext:Localize Chat.Placeholder}" 
                               Background="Transparent" 
                               BorderThickness="0" 
                               AcceptsReturn="True" TextWrapping="Wrap" MaxHeight="100"
                               Margin="15,0">
                          <TextBox.KeyBindings>
                              <KeyBinding Gesture="Enter" Command="{Binding SendMessageCommand}"/>
                          </TextBox.KeyBindings>
                      </TextBox>
                      
                      <Button Grid.Column="1" Command="{Binding SendMessageCommand}" 
                              Width="40" Height="40" CornerRadius="20" Classes="accent" IsVisible="{Binding !IsGenerating}">
                          <PathIcon Data="M2,21L23,12L2,3V10L17,12L2,14V21Z" Width="18" Height="18" Foreground="Black" Margin="2,0,0,0"/>
                      </Button>
                      <Button Grid.Column="1" Command="{Binding StopGenerationCommand}" 
                              Width="40" Height="40" CornerRadius="20" Background="#AA3333" IsVisible="{Binding IsGenerating}" ToolTip.Tip="{ext:Localize Chat.Stop}">
                          <PathIcon Data="M6,6H18V18H6V6Z" Width="16" Height="16" Foreground="White"/>
                      </Button>
                  </Grid>
              </Border>
          </Grid>
          
      </Grid>
  </Grid>
</UserControl>
